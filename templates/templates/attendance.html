{% extends "base.html" %}

{% block page_title %}Attendance Tracking{% endblock %}

{% block content %}
<div class="row">
    <div class="col-6">
        <div class="stat-card">
            <h3>Attendance Trends</h3>
            <div style="height: 300px; display: flex; align-items: flex-end; gap: 10px; margin-top: 20px;">
                {% for month, count in trends.items() %}
                <div style="flex: 1; text-align: center;">
                    <div style="height: {{ count }}px; max-height: 250px; background: #2a7f4b; border-radius: 5px 5px 0 0; margin-bottom: 5px;"></div>
                    <div style="font-size: 0.8rem;">{{ month }}</div>
                    <div style="font-weight: bold;">{{ count }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <div class="col-6">
        <div class="stat-card">
            <h3>Alert Status</h3>
            <div style="background: {% if 'Excellent' in alert %}#d4edda{% else %}#f8d7da{% endif %}; padding: 20px; border-radius: 10px; color: {% if 'Excellent' in alert %}#155724{% else %}#721c24{% endif %};">
                <i class="fas fa-{% if 'Excellent' in alert %}check-circle{% else %}exclamation-triangle{% endif %}" style="font-size: 2rem; margin-right: 10px;"></i>
                {{ alert }}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="stat-card">
            <h3>Department Attendance</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>Department</th>
                        <th>Attendance</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    {% for dept, count in dept_attendance.items() %}
                    <tr>
                        <td>{{ dept }}</td>
                        <td>{{ count }}</td>
                        <td>{{ "%.1f"|format((count / trends.values()|sum if trends.values()|sum > 0 else 1) * 100) }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="stat-card">
            <h3>Generate QR Code</h3>
            <div class="row">
                <div class="col-4">
                    <select class="form-control" id="qrService">
                        <option>Sunday Morning Service</option>
                        <option>Wednesday Service</option>
                        <option>Friday Prayer</option>
                        <option>Youth Service</option>
                        <option>Children's Church</option>
                    </select>
                </div>
                <div class="col-3">
                    <input type="date" class="form-control" id="qrDate" value="{{ now().strftime('%Y-%m-%d') }}">
                </div>
                <div class="col-3">
                    <select class="form-control" id="qrValidity">
                        <option value="60">1 Hour</option>
                        <option value="120">2 Hours</option>
                        <option value="240" selected>4 Hours</option>
                        <option value="480">8 Hours</option>
                    </select>
                </div>
                <div class="col-2">
                    <button class="btn btn-success" style="width: 100%;" onclick="generateQRCode()">
                        <i class="fas fa-qrcode"></i> Generate
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function generateQRCode() {
        let service = document.getElementById('qrService').value;
        let date = document.getElementById('qrDate').value;
        let validity = document.getElementById('qrValidity').value;
        
        fetch('/api/generate_qr', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                service: service,
                date: date,
                validity: validity
            })
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                alert('QR Code generated successfully!\nQR ID: ' + data.qr_id + '\nValid for: ' + validity/60 + ' hours');
            }
        });
    }
</script>
{% endblock %}