{% extends "base.html" %}

{% block page_title %}Dashboard{% endblock %}

{% block content %}
<!-- Stats Cards -->
<div class="row">
    <div class="col-3">
        <div class="stat-card">
            <div class="stat-title">Total Members</div>
            <div class="stat-number">{{ total_members }}</div>
            <a href="/members" class="stat-link">
                View <i class="fas fa-arrow-right"></i>
            </a>
        </div>
    </div>
    
    <div class="col-3">
        <div class="stat-card">
            <div class="stat-title">New Members</div>
            <div class="stat-number">{{ new_members }}</div>
            <a href="/members" class="stat-link">
                View <i class="fas fa-arrow-right"></i>
            </a>
        </div>
    </div>
    
    <div class="col-3">
        <div class="stat-card">
            <div class="stat-title">Total Children</div>
            <div class="stat-number">{{ total_children }}</div>
            <a href="/children" class="stat-link">
                View <i class="fas fa-arrow-right"></i>
            </a>
        </div>
    </div>
    
    <div class="col-3">
        <div class="stat-card">
            <div class="stat-title">Financial Balance</div>
            <div class="stat-number">R {{ "%.2f"|format(balance) }}</div>
            <a href="/finance" class="stat-link">
                View <i class="fas fa-arrow-right"></i>
            </a>
        </div>
    </div>
</div>

<!-- Quick Actions and Birthdays -->
<div class="row">
    <div class="col-6">
        <div class="stat-card">
            <h3 style="margin-bottom: 20px; color: #333;">Quick Actions</h3>
            <div class="row">
                <div class="col-6">
                    <button class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="showAddMember()">
                        <i class="fas fa-user-plus"></i> Add Member
                    </button>
                    <button class="btn btn-info" style="width: 100%; margin-bottom: 10px;" onclick="generateQR()">
                        <i class="fas fa-qrcode"></i> QR Attendance
                    </button>
                    <button class="btn btn-success" style="width: 100%; margin-bottom: 10px;" onclick="location.href='/finance'">
                        <i class="fas fa-plus-circle"></i> Add Transaction
                    </button>
                </div>
                <div class="col-6">
                    <button class="btn btn-warning" style="width: 100%; margin-bottom: 10px;" onclick="location.href='/sms'">
                        <i class="fas fa-sms"></i> Send SMS
                    </button>
                    <button class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;" onclick="showPrayerRequest()">
                        <i class="fas fa-pray"></i> Prayer Request
                    </button>
                    <button class="btn btn-danger" style="width: 100%; margin-bottom: 10px;" onclick="showFeedback()">
                        <i class="fas fa-comment"></i> Feedback
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-6">
        <div class="stat-card">
            <h3 style="margin-bottom: 20px; color: #333;">Birthdays This Month</h3>
            <div style="text-align: center;">
                <span style="font-size: 4rem; color: #1e3c2c;">{{ birthdays }}</span>
                <p style="color: #666; font-size: 1.2rem;">Celebrating this month</p>
            </div>
            <div style="margin-top: 20px;">
                <p><i class="fas fa-birthday-cake" style="color: #ffd700;"></i> This Week: 11</p>
            </div>
        </div>
    </div>
</div>

<!-- Distribution Charts -->
<div class="row">
    <div class="col-6">
        <div class="stat-card">
            <h3 style="margin-bottom: 20px; color: #333;">Gender Distribution</h3>
            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                <div style="width: 100px; color: #666;">Male:</div>
                <div style="flex: 1; height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden;">
                    <div style="height: 100%; width: {{ gender_dist.get('Male', '0%') }}; background: #2a7f4b;"></div>
                </div>
                <div style="width: 80px; text-align: right; font-weight: 600;">{{ gender_dist.get('Male', '0%') }}</div>
            </div>
            <div style="display: flex; align-items: center;">
                <div style="width: 100px; color: #666;">Female:</div>
                <div style="flex: 1; height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden;">
                    <div style="height: 100%; width: {{ gender_dist.get('Female', '0%') }}; background: #ffd700;"></div>
                </div>
                <div style="width: 80px; text-align: right; font-weight: 600;">{{ gender_dist.get('Female', '0%') }}</div>
            </div>
        </div>
    </div>
    
    <div class="col-6">
        <div class="stat-card">
            <h3 style="margin-bottom: 20px; color: #333;">Age Distribution</h3>
            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                <div style="width: 100px; color: #666;">Under 18:</div>
                <div style="flex: 1; height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden;">
                    <div style="height: 100%; width: {{ age_dist.get('Under 18', '0%') }}; background: #3498db;"></div>
                </div>
                <div style="width: 80px; text-align: right; font-weight: 600;">{{ age_dist.get('Under 18', '0%') }}</div>
            </div>
            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                <div style="width: 100px; color: #666;">18-35:</div>
                <div style="flex: 1; height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden;">
                    <div style="height: 100%; width: {{ age_dist.get('18-35', '0%') }}; background: #2ecc71;"></div>
                </div>
                <div style="width: 80px; text-align: right; font-weight: 600;">{{ age_dist.get('18-35', '0%') }}</div>
            </div>
            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                <div style="width: 100px; color: #666;">36-60:</div>
                <div style="flex: 1; height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden;">
                    <div style="height: 100%; width: {{ age_dist.get('36-60', '0%') }}; background: #f1c40f;"></div>
                </div>
                <div style="width: 80px; text-align: right; font-weight: 600;">{{ age_dist.get('36-60', '0%') }}</div>
            </div>
            <div style="display: flex; align-items: center;">
                <div style="width: 100px; color: #666;">Over 60:</div>
                <div style="flex: 1; height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden;">
                    <div style="height: 100%; width: {{ age_dist.get('Over 60', '0%') }}; background: #e74c3c;"></div>
                </div>
                <div style="width: 80px; text-align: right; font-weight: 600;">{{ age_dist.get('Over 60', '0%') }}</div>
            </div>
        </div>
    </div>
</div>

<!-- Add Member Modal -->
<div id="addMemberModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000;">
    <div style="background: white; width: 500px; margin: 100px auto; padding: 30px; border-radius: 10px;">
        <h3 style="margin-bottom: 20px;">Add New Member</h3>
        
        <div class="form-group">
            <label class="form-label">First Name</label>
            <input type="text" class="form-control" id="first_name" required>
        </div>
        
        <div class="form-group">
            <label class="form-label">Last Name</label>
            <input type="text" class="form-control" id="last_name" required>
        </div>
        
        <div class="form-group">
            <label class="form-label">Phone</label>
            <input type="text" class="form-control" id="phone" required>
        </div>
        
        <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" id="email">
        </div>
        
        <div class="form-group">
            <label class="form-label">Department</label>
            <select class="form-control" id="department">
                <option>Intercessors</option>
                <option>Media</option>
                <option>Administration</option>
                <option>Choir</option>
                <option>Ushering</option>
                <option>Children</option>
                <option>Protocol</option>
            </select>
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
            <button class="btn btn-secondary" onclick="hideAddMember()">Cancel</button>
            <button class="btn btn-success" onclick="saveMember()">Save Member</button>
        </div>
    </div>
</div>

<script>
    function showAddMember() {
        document.getElementById('addMemberModal').style.display = 'block';
    }
    
    function hideAddMember() {
        document.getElementById('addMemberModal').style.display = 'none';
    }
    
    function generateQR() {
        let service = prompt("Enter service type (e.g., Sunday Service):");
        if(service) {
            fetch('/api/generate_qr', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    service: service,
                    date: new Date().toISOString().split('T')[0],
                    validity: 240
                })
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    alert('QR Code generated successfully! ID: ' + data.qr_id);
                }
            });
        }
    }
    
    function showPrayerRequest() {
        alert('Prayer request feature coming soon!');
    }
    
    function showFeedback() {
        alert('Feedback feature coming soon!');
    }
    
    function saveMember() {
        const member = {
            first_name: document.getElementById('first_name').value,
            last_name: document.getElementById('last_name').value,
            phone: document.getElementById('phone').value,
            email: document.getElementById('email').value,
            department: document.getElementById('department').value,
            role: 'Member',
            status: 'Active',
            gender: 'Male',
            date_of_birth: '1990-01-01'
        };
        
        fetch('/api/add_member', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(member)
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                alert('Member added successfully! ID: ' + data.member_id);
                location.reload();
            }
        });
    }
</script>
{% endblock %}